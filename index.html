<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Sentiment Analysis Gmail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        h1 { font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .btn-google {
            background: linear-gradient(45deg, #db4437, #c23321);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-google:hover {
            background: linear-gradient(45deg, #e57368, #d45b4f);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .btn-primary, .btn-danger { transition: all 0.3s ease; }
        .btn-primary:hover, .btn-danger:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        table { border-collapse: separate !important; border-spacing: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; }
        .table th, .table td { padding: 1rem 1.25rem; text-align: center; }
        .table th { background-color: #343a40; color: white; }
        table thead tr th:first-child { border-top-left-radius: 12px; }
        table thead tr th:last-child { border-top-right-radius: 12px; }
        table tbody tr:last-child td:first-child { border-bottom-left-radius: 12px; }
        table tbody tr:last-child td:last-child { border-bottom-right-radius: 12px; }
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .table-danger { background-color: #f8d7da !important; }
        #loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
        .toast { margin-bottom: 0.5rem; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #sort-sentiment-btn { font-size: 0.8rem; }
    </style>
</head>
<body class="d-flex flex-column align-items-center p-4">

    <h1 class="mb-4">Sentiment Analysis Gmail</h1>

    <div id="login-section" class="mb-3">
        <button id="login-btn" class="btn btn-google btn-lg d-flex align-items-center">
            <img src="https://www.gstatic.com/images/branding/product/1x/gmail_48dp.png" alt="Gmail" width="24" height="24" class="me-2">
            Continua con Gmail
        </button>
    </div>

    <div id="actions-section" class="mb-3 d-none">
        <button id="analyze-btn" class="btn btn-primary me-2">Analizza le nuove email</button>
        <button id="logout-btn" class="btn btn-danger">Logout</button>
    </div>

    <div id="loading-spinner" class="mt-3 d-none">
        <div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2 text-danger">Analisi in corso...</p>
    </div>

    <div class="table-responsive w-100 mt-4">
        <table id="results-table" class="table table-hover table-bordered d-none w-100">
            <thead class="thead-dark">
                <tr>
                    <th>Mittente</th>
                    <th>Oggetto</th>
                    <th>Testo</th>
                    <th>
                        <div class="d-flex align-items-center justify-content-center">
                            <span>Sentiment</span>
                            <button id="sort-sentiment-btn" class="btn btn-sm btn-light ms-2">↕</button>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loginBtn = document.getElementById("login-btn");
            const analyzeBtn = document.getElementById("analyze-btn");
            const logoutBtn = document.getElementById("logout-btn");
            const loginSection = document.getElementById("login-section");
            const actionsSection = document.getElementById("actions-section");
            const resultsTable = document.getElementById("results-table");
            const resultsBody = resultsTable.querySelector("tbody");
            const loadingSpinner = document.getElementById("loading-spinner");
            const toastContainer = document.getElementById("toast-container");

            function showToast(message, type="success") {
                const toastEl = document.createElement("div");
                toastEl.className = `toast align-items-center text-bg-${type} border-0`;
                toastEl.setAttribute("role", "alert");
                toastEl.setAttribute("aria-live", "assertive");
                toastEl.setAttribute("aria-atomic", "true");

                toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
                toastContainer.appendChild(toastEl);

                const bsToast = new bootstrap.Toast(toastEl, { delay: 2000, autohide: true });
                bsToast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }

            function showLoggedInUI() {
                loginSection.classList.add("d-none");
                actionsSection.classList.remove("d-none");
            }
            function showLoggedOutUI() {
                loginSection.classList.remove("d-none");
                actionsSection.classList.add("d-none");
                resultsTable.classList.add("d-none");
                loadingSpinner.classList.add("d-none");
            }

            // Controllo login
            fetch("/check_login").then(res => res.json()).then(data => {
                if (data.logged_in) showLoggedInUI();
                else showLoggedOutUI();
            });

            loginBtn.addEventListener("click", () => window.location.href = "/authorize");

            logoutBtn.addEventListener("click", () => {
                fetch("/logout", { method: "POST" })
                    .then(res => res.json())
                    .then(() => { showLoggedOutUI(); showToast("Logout eseguito con successo", "success"); });
            });

            analyzeBtn.addEventListener("click", () => {
                loadingSpinner.classList.remove("d-none");
                resultsTable.classList.add("d-none");

                fetch("/analyze_emails?limit=25")
                    .then(res => res.json())
                    .then(data => {
                        resultsBody.innerHTML = "";
                        data.forEach(email => {
                            const tr = document.createElement("tr");
                            let sentimentClass = "";
                            if (email.sentiment < 0.40) sentimentClass = "table-danger";
                            else if (email.sentiment < 0.60) sentimentClass = "table-warning";
                            tr.className = sentimentClass;
                            tr.innerHTML = `<td>${email.mittente || ""}</td><td>${email.oggetto || ""}</td><td>${email.testo || ""}</td><td>${(email.sentiment!==undefined?email.sentiment.toFixed(3):"-")}</td>`;
                            resultsBody.appendChild(tr);
                        });
                        loadingSpinner.classList.add("d-none");
                        resultsTable.classList.remove("d-none");
                    })
                    .catch(() => { loadingSpinner.classList.add("d-none"); showToast("Errore durante l'analisi delle email", "danger"); });
            });

            // Ordinamento sentiment
            const sortBtn = document.getElementById("sort-sentiment-btn");
            let sortState = 0;
            let originalRows = [];
            sortBtn.addEventListener("click", () => {
                const rows = Array.from(resultsBody.querySelectorAll("tr"));
                if (sortState === 0 && rows.length > 0) originalRows = rows.slice();
                if (sortState === 0) { rows.sort((a,b)=>parseFloat(b.cells[3].textContent)-parseFloat(a.cells[3].textContent)); sortBtn.textContent="↑"; sortState=1; }
                else if (sortState===1){ rows.sort((a,b)=>parseFloat(a.cells[3].textContent)-parseFloat(b.cells[3].textContent)); sortBtn.textContent="↓"; sortState=2; }
                else{ resultsBody.innerHTML=""; originalRows.forEach(r=>resultsBody.appendChild(r)); sortBtn.textContent="↕"; sortState=0; return; }
                resultsBody.innerHTML=""; rows.forEach(r=>resultsBody.appendChild(r));
            });

            // --- Visualizzazione toast da query string ---
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("login_success")) { showLoggedInUI(); showToast("Login eseguito con successo", "success"); }
            if (urlParams.get("oauth_error")) {
                let msg = "Errore durante l'autenticazione";
                switch(urlParams.get("oauth_error")){
                    case "access_denied": msg="Accesso negato dall'utente"; break;
                    case "oauth_error": msg="Errore OAuth generico"; break;
                    case "unknown_error": msg="Errore imprevisto durante OAuth"; break;
                    case "no_email": msg="Impossibile ottenere l'email dell'utente"; break;
                }
                showToast(msg,"danger");
            }
            // Pulizia query string
            if(urlParams.get("login_success") || urlParams.get("oauth_error")) window.history.replaceState({}, document.title, "/");
        });
    </script>

</body>
</html>
